name: 📝 Auto Update Documentation

on:
  push:
    branches: 
      - main
      - master
      - test-*                  # Cho phép test trên branch test-*
      - feature/*               # Hoặc branch feature/*
    paths:
      - 'Solutions/**'          # Chỉ chạy khi có thay đổi trong Solutions
  pull_request:
    branches: [ main, master ]
    paths:
      - 'Solutions/**'
  workflow_dispatch:            # Cho phép chạy manual

jobs:
  update-documentation:
    runs-on: ubuntu-latest
    
    steps:
    - name: 🛒 Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: 🐍 Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: 📊 Show Repository Structure
      run: |
        echo "📁 Repository structure:"
        echo "Root files:"
        ls -la
        echo ""
        echo "Scripts folder:"
        ls -la Scripts/ 2>/dev/null || echo "Scripts folder not found"
        echo ""
        echo "Docs folder:"
        ls -la Docs/ 2>/dev/null || echo "Docs folder not found" 
        echo ""
        echo "Solutions structure (first 10):"
        find Solutions -type d 2>/dev/null | head -10 || echo "Solutions folder not found"
        
    - name: 🔄 Run Documentation Update Script
      run: |
        echo "🚀 Running Scripts/update_progress.py..."
        python Scripts/update_progress.py
        
    - name: 📋 Check for Changes
      id: check_changes
      run: |
        git status
        if [ -n "$(git status --porcelain)" ]; then
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "📝 Changes detected in:"
          git status --short
          echo ""
          echo "📄 Modified files:"
          git diff --name-only
        else
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "ℹ️ No changes detected"
        fi
        
    - name: ⚙️ Configure Git
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
    - name: 📝 Commit and Push Changes
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        echo "📤 Committing changes..."
        git add Docs/*.md
        
        # Tạo commit message với thông tin chi tiết
        CHANGED_FILES=$(git diff --cached --name-only)
        BRANCH_NAME=${GITHUB_REF#refs/heads/}
        
        if [[ "$BRANCH_NAME" == "main" || "$BRANCH_NAME" == "master" ]]; then
          COMMIT_PREFIX="📝 Auto-update documentation"
        else
          COMMIT_PREFIX="🧪 [TEST] Auto-update documentation"
        fi
        
        echo "Changed files: $CHANGED_FILES"
        
        git commit -m "$COMMIT_PREFIX

📊 Updated documentation files:
$CHANGED_FILES

🔧 Details:
- Branch: $BRANCH_NAME
- Script: Scripts/update_progress.py  
- Trigger: ${{ github.event_name }}
- Commit: $(echo ${{ github.sha }} | cut -c1-8)

[skip ci]"
        
        # Push vào cùng branch đang làm việc
        git push origin HEAD:$BRANCH_NAME
        
    - name: 📊 Summary
      run: |
        echo "## 📊 Documentation Update Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.check_changes.outputs.changes }}" == "true" ]; then
          echo "✅ **Documentation updated successfully!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📝 Files Updated:" >> $GITHUB_STEP_SUMMARY
          git show --name-only --pretty="" HEAD | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🔧 Details:" >> $GITHUB_STEP_SUMMARY
          echo "- **Script:** Scripts/update_progress.py" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${GITHUB_REF#refs/heads/}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        else
          echo "ℹ️ **No updates needed** - documentation is already up to date!" >> $GITHUB_STEP_SUMMARY
        fi